<!-- A more robust test of api: ensuring consistency for error reporting -->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forum Page</title>
</head>

<body>
    <div id="posts"></div>

    <div id="loginForm">
        <input type="text" id="email" placeholder="Email Address">
        <input type="password" id="password" placeholder="Password">
        <button id="loginButton">Log In</button>
        <ul id="loginErrors">

        </ul>
    </div>

    <div id="postForm" style="display: none;">
        <textarea id="postContent" placeholder="Write your post"></textarea>
        <button id="postButton">Post</button>
    </div>

    <div id="commentForm" style="display: none;">
        <textarea id="commentContent" placeholder="Write your comment"></textarea>
        <button id="commentButton">Comment</button>
    </div>

    <script>
        const baseUrl = "http://localhost:3000"; // Replace with the actual API base URL after backend deployment
        // const baseUrl = "https://philly-outreach-67a8895e1869.herokuapp.com"

        // console.log('test', localStorage.getItem('token'));
        const postsContainer = document.getElementById("posts");
        const loginForm = document.getElementById("loginForm");
        const postForm = document.getElementById("postForm");
        const commentForm = document.getElementById("commentForm");

        const loginButton = document.getElementById("loginButton");
        const postButton = document.getElementById("postButton");
        const commentButton = document.getElementById("commentButton");

        const loginErrors = document.getElementById("loginErrors");

        let token = localStorage.getItem('token') ? localStorage.getItem('token') : ""; // Store the token received after successful login

        (async function persistentLogin() {
            console.log('in persistent login', token)
            if (token) {
                let login = await fetch(`${baseUrl}/auth/passport`, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`
                    }
                });
                console.log(login.headers, 'response')
            } else {
                return null
            }
        })();

        // Function to fetch posts and display them
        async function fetchAndDisplayPosts() {
            const response = await fetch(`${baseUrl}/api/posts`);
            const posts = await response.json();

            postsContainer.innerHTML = "";

            posts.forEach(post => {
                const postElement = document.createElement("div");
                postElement.innerHTML = `<h3>${post.title}</h3><p>${post.content}</p>`;
                postsContainer.appendChild(postElement);
            });
        }

        // Event listeners
        loginButton.addEventListener("click", async (e) => {
            e.preventDefault();

            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            const response = await fetch(`${baseUrl}/auth/passport/login`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ email, password })
            });
            let body = response.body;

            let rezzy = await response.json()
            await localStorage.setItem('token', rezzy.token)
            console.log(rezzy)


            if (!rezzy.error) {
                // const data = await response.json();
                token = rezzy.token;
                loginForm.style.display = "none";
                postForm.style.display = "block";
                commentForm.style.display = "block";
                fetchAndDisplayPosts();
            } else {
                // let error = document.createElement("li");
                loginErrors.innerHTML = `${rezzy.error}`;
                // loginErrors.append(error);
            }
            //  else {
            //     alert("Login failed. Please check your credentials.");
            // }
        });

        postButton.addEventListener("click", async (e) => {
            e.preventDefault();

            const postContent = document.getElementById("postContent").value;

            await fetch(`${baseUrl}/api/posts`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({ content: postContent })
            });

            fetchAndDisplayPosts();
        });

        commentButton.addEventListener("click", async (e) => {
            e.preventDefault();
            const commentContent = document.getElementById("commentContent").value;

            // Assuming you have an API endpoint for adding comments
            // Replace "POST_ID" with the actual post ID
            let postId = 'placeholder'
            await fetch(`${baseUrl}/api/comments`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({ content: commentContent })
            });

            fetchAndDisplayPosts();
        });
    </script>
</body>

</html>
